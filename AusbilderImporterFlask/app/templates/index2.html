<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Home</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .blacklist {
            color: red;
        }
    </style>
</head>
<body>
    <h1>Home</h1>
    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <ul>
        {% for message in messages %}
        <li>{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    {% endwith %}

    {% if not students %}
    <p>No students found. Please <a href="{{ url_for('upload_file') }}">upload a CSV file</a>.</p>
    {% else %}
    <h2>Classes</h2>
    <form action="{{ url_for('update_ini') }}" method="post">
        <textarea name="classes">{{ ','.join(classes) }}</textarea>
        <br>
        <input type="submit" value="Update Classes">
    </form>

    <h2>Blacklist</h2>
    <form action="{{ url_for('update_ini') }}" method="post">
        <textarea name="blacklist" id="blacklist-textarea">{{ ','.join(blacklist) }}</textarea>
        <br>
        <input type="submit" value="Update Blacklist">
    </form>

    <h2>Students</h2>
    <table border="1">
        <thead>
            <tr>
                <th>Interne ID-Nummer</th>
                <th>Vorname</th>
                <th>Nachname</th>
                <th>Klasse</th>
                <th>Blacklist Action</th>
            </tr>
        </thead>
        <tbody>
            {% for student in students %}
            <tr id="student-{{ student['Interne ID-Nummer'] }}" class="{{ 'blacklist' if student['Interne ID-Nummer'] in blacklist else '' }}">
                <td>{{ student['Interne ID-Nummer'] }}</td>
                <td>{{ student['Vorname'] }}</td>
                <td>{{ student['Nachname'] }}</td>
                <td>{{ student['Klasse'] }}</td>
                <td>
                    {% if student['Interne ID-Nummer'] in blacklist %}
                    <button class="blacklist-action" data-id="{{ student['Interne ID-Nummer'] }}" data-action="remove">Remove from Blacklist</button>
                    {% else %}
                    <button class="blacklist-action" data-id="{{ student['Interne ID-Nummer'] }}" data-action="add">Add to Blacklist</button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    <script>
    $(document).ready(function() {
      $('.blacklist-action').click(function() {
        var studentId = $(this).data('id');
        var action = $(this).data('action');
        var button = $(this);

        $.ajax({
          type: 'POST',
          url: action === 'add' ? '{{ url_for("add_to_blacklist") }}' : '{{ url_for("remove_from_blacklist") }}',
          data: { student_id: studentId },
          success: function(response) {
            if (response.status === 'success') {
              var row = $('#student-' + studentId);
              var blacklistTextarea = $('#blacklist-textarea');
              var blacklist = blacklistTextarea.val().split(',');

              if (action === 'add') {
                row.addClass('blacklist');
                button.data('action', 'remove').text('Remove from Blacklist');
                if (!blacklist.includes(studentId.toString())) {
                  blacklist.push(studentId.toString());
                }
              } else {
                row.removeClass('blacklist');
                button.data('action', 'add').text('Add to Blacklist');
                blacklist = blacklist.filter(id => id !== studentId.toString());
              }

              blacklistTextarea.val(blacklist.join(','));
            }
          }
        });

        return false;
      });
    });
    </script>

    <p><a href="{{ url_for('index') }}">Back to Home</a></p>
</body>
</html>
